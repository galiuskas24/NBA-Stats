---
title: "Projekt iz kolegija: Statistička analiza podataka"
subtitle: "Statistika NBA igrača"
author: "Disperzanti - Vlado Galić, Tin Komerički, Marino Voćanec"
date: "12/05/2019"
header-includes:
   - \usepackage{float}
output:
    pdf_document
fontsize: 12pt
---

```{r setup, echo=FALSE, include=FALSE}
#pdf.options(encoding = "UTF-8")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE,fig.width=6, fig.height=4, fig.align='center')
require(dplyr)
require(gridExtra)
require(car)
require(bootstrap)
require(ggplot2)
require(measurements)
set.seed(42)
Sys.setlocale("LC_ALL", 'hr_HR.UTF-8')
Sys.setenv(LANG = "hr_HR.UTF-8")

players.bySeasons <- read.csv("nba-players-stats/Seasons_Stats.csv")
players.bySeasons.info <- read.csv("nba-players-stats/Players.csv")

graph.col = "deepskyblue"

pos.labels = c("PG", "SG", "SF", "PF", "C")
pos.colors = c("lightgreen", "darkturquoise", "firebrick1", "burlywood4", "yellow3")



# ---------------------------------- Utility functions ---------------------------------- #

#' Function which calculates a confidence interval for bootstrap sample.
#' @param x first population 
#' @param y second population (optional)
#' @param B number of bootstrap replicas (# of samples)
#' @param alpha level of significance
#' @param alternative two sided or specific one sided test? possible options: 'two.sided', 'greater', 'less'
#' @param f function applied on bootstrap samples
#' @return vector containing lower and upper bound of confidence interval or NULL in case of invalid input
#' @examples
#' bs.intreval(players, B = 1000, alternative = "greater")
#' bs.intreval(x = players, y = HOF.players, alpha = 0.01, alternative = "greater")
bs.interval <- function(x, y = NULL, B = 1E5, alpha = 0.05, alternative = "two.sided", f = mean) {
  boot = bootstrap(x, B, f)$thetastar
  if(!is.null(y)) {
    boot = boot - bootstrap(y, B, f)$thetastar
  }
  boot = sort(boot)
  
  if(alternative == "two.sided") {
    return (c(boot[B*alpha/2], boot[B*(1-alpha/2)]))
    
  } else if(alternative == "greater") {
    return (c(boot[B*alpha], +Inf))
    
  } else if(alternative == "less") {
    return (c(-Inf, boot[B*(1-alpha)]))
  }
  
  return (NULL)
}

#' Function which prints Bootstrap interval.
#' @param interval Bootstrap interval
#' @param precision decimal precision
#' @return nothing
#' @examples
#' print.bs.interval(interval)
#' print.bs.interval(interval, precision = 2)
print.bs.interval <- function(interval, precision = 5) {
  lower.bound = round(interval[1], digits = precision)
  upper.bound = round(interval[2], digits = precision)
  message("Interval povjerenja jednak je: [", lower.bound, ", ", upper.bound, "].")
}

#' Function which standardizes some random variable (calculates z-score).
#' @param varible random variable to standardize
#' @return nothing
#' @examples
#' standardize(player.points)
standardize <- function(variable){
  return((variable - mean(variable)) / sd(variable))
}

#' @param players list of players dataframe
#' @param player_names vector of player names 
#' @param colors vector of colors
#' @param columns vector of category names (for comparation) 
#' @param values vector of important vertical lines to show (mean, median,..)
#' @return ggplot
#' @example
#' custom.ggplot(
#'  list(bryant, jordan, james, durant),
#'  c("Bryant", "Jordan", "James", "Durant"),
#'  c("#a00e0e", "#e5aa22", "#2260e5", "#330547"),
#'  c("Points", "Asists", "Rebounds", "Turnovers", "Steals", "+/-"),
#'  c(points, asists, rebounds, turnovers, steals, plus.minus)
#' )
custom.ggplot <- function(players, player_names, colors, columns, values){

  Variable <- factor(rep(columns, rep(length(players),length(columns))))
  Legend <- factor(rep(player_names, length(columns)))
  data <- data.frame(Variable,Legend, values)

  ggplot(data, aes(x=Variable, y=values,fill=Legend, colour=Legend)) + 
  geom_bar(stat="identity", position="dodge")+
  scale_color_manual(values=rep("black", length(players))) + 
  scale_fill_manual(values=rev(colors))
}

```



# Predgovor
U sklopu projekta iz kolegija "Statistička analiza podataka" naš zadatak je osmisliti zanimljiva pitanja i hipoteze koje ćemo pokušati dokazati (odnosno opovrgnuti) koristeći dosad stećeno znanje na kolegiju. Konkretno naš projekt je vezan uz statistiku NBA igrača od 1950. godine. Skup podataka koji proučavamo sadrži preko 3000 igrača kroz 67 sezona. Za svakog igrača prisutne su sve važne vrijednosti koje će nam poslužiti kako bi mogli donositi zanimljive zaključke.

Projekt je koncipiran po cjelinama na takav način da svaka pojedina cjelina zapravo predstavlja jedno zanimljivo pitanje ili hipotezu koju onda dokazujemo. Testovi i regresije koje provodimo su popraćene brojnim vizualizacijama podataka kako bi čitatelju pojednostavili proučavanje dokumenta i dodatno približili ono što se testom ili regresijom zapravo i pokazuje.


\newpage
# 1. Jesu li su viši centri nužno i bolji skakači?
Centar je igrač koji većinu svog vremena provodi pod košem vrebajući skokove. Zbog toga je zanimljivo proučavati je li visina igrača bitan parametar za skupljanje skokova? Prirodno bi bilo očekivati da će visina igrača pozitivno utjecati na količinu skokova. No, je li to baš uvijek tako? Ljubitelji košarke bi mogli tvrditi nešto što se možda na prvi pogled ne čini tako intuitivnim.
```{r, echo=FALSE}
# Load players which play center position.
players.bySeasons %>% select(Year, G, Player, Pos, TRB) %>%
                  na.omit %>%
                  filter(grepl("C", Pos)) %>%
                  group_by(Player) %>%
                  summarize(RPG = sum(TRB)/sum(G)) -> centers

# Load personal information of players and make inner join with centers.
players.bySeasons.info %>% select(Player, height, weight) -> players.info
merge(centers, players.info) -> centers
```

Najprije ćemo vizualizirati podatke kako bismo vidjeli postoji li bilo kakva povezanost izemđu visine i broja skokova.    
\bigbreak
```{r, echo=FALSE}
hist(centers$height, main = "Razdioba visina centara", xlab = "Visina centara", ylab = "Frekvencija", col = graph.col)
```
\bigbreak
```{r}
boxplot(centers$height, main = "Visina centara", col = graph.col)
```
\bigbreak
```{r}
hist(centers$RPG, main = "Razdioba broja skokova centara", xlab = "Broj skokova centara", ylab = "Frekvencija", col = graph.col)
```
\bigbreak
```{r}
boxplot(centers$RPG, main = "Broj skokova centara", col = graph.col)
```
\bigbreak
```{r}
plot(centers$height, centers$RPG, main = "Visina i broj skokova centara", xlab = "Visina centara", ylab = "Broj skokova centara", col = graph.col)
```

\bigbreak
Sljedeće što ćemo napraviti jest razdijeliti centre u 2 skupine: više i niže centre. Niži centri su svi oni koji imaju visinu manju od srednje vrijednosti umanjene za 5% ranga visina. Na isti način se određuju i viši centri, samo što se kod viših centara izračunati postotak nadodaje na srednju vrijednost.
```{r}
# Define percent of a rank for left and right cut (mean -+ cut.percent * rank).
cut.percent = 0.05

# Determine lower and upper bound for centers.
c.mean = mean(centers$height)
c.rank = max(centers$height) - min(centers$height)

c.lb = c.mean - cut.percent * c.rank
c.up = c.mean + cut.percent * c.rank

# Divide centers in two categories: lower and higher and calculate their means.
centers[centers$height < c.lb,] -> lower.centers
centers[centers$height > c.up,] -> higher.centers
lower.mean = mean(lower.centers$RPG)
higher.mean = mean(higher.centers$RPG)
```

Nakon što smo centre podijelili na niže i više primijenti ćemo Bootstrap tehniku kako bismo utvrdili da li NIŽI igrači na poziciji centra imaju višeskokova od VIŠIH centara. Ovo možda na prvi pogled djeluje čudo, ali pogledajmo što će reći rezultati postupka.
\bigbreak
```{r}
message("Srednja vrijednost broja skokova nizih centara: ", round(lower.mean, digits = 5))
message("Srednja vrijednost broja skokova visih centara: ", round(higher.mean, digits = 5))

bs.alpha = 0.01
interval = bs.interval(x = lower.centers$RPG, y = higher.centers$RPG, alpha = bs.alpha, alternative = "greater")
print.bs.interval(interval)
```
Kako vrijednost 0 'nije upala' u 95%-tni interval povjerenja za razliku broja skokova između nižih i viših centara, možemo tvrditi na razini značajnosti od 5% kako niži centri imaju više skokova od viših. No, valja biti oprezan! Ovaj rezultat jest statistički značajan, ali je značajnost u domeni košarke upitna. Ipak, radi se o razlici između broja skokova po utakcimi ne većoj od 0.5 što možda u nekom kontekstu i nije toliko bitna razlika.


\newpage
# 2. Evolucija šuta za tri poena
Čak i netko tko površno prati NBA ligu može uočiti jedan zanimljiv trend a to je da se u današnjoj košarci šuta puno više trica. Teško je naći baš razlog zbog čega se to događa ali očito je da su igrači sve više vještiji u šutiranju trica pa čak i oni koji igraju poziciju centra (inače loši šuteri za 3). Na grafu prikazujemo ZELENOM bojom broj poena po timu po sezoni, a CRVENOM prosječan broj zabijenih trica u toj sezoni.

```{r, echo=FALSE}
read.csv("nba-players-stats/Seasons_info_full.csv") -> seasons
read.csv("nba-players-stats/Seasons_info.csv") -> seasons.teams.games

```

Broj koševa po NBA sezoni:
\bigbreak
```{r}
seasons %>% filter(Year >= 1979) -> seasons
plot(seasons$Year, seasons$PTS, type="l", col="red", yaxt='n', ann=FALSE)
par(new=TRUE)
seasons$X3P <- seasons$X3P*3
plot(seasons$Year, seasons$X3P, type="l", col="green", xlab="Godine", ylab="Broj poena")

```

Također možemo zapaziti da današnji igrači u prosjeku više zabiju trica nego tadašnji bek šuteri. To je također dokaz evolucije igre i uvježbavanja vještine kao što je šut za tri poena. Nadalje, zanimljivo je uočiti kako je od 1979. godine (odnosno godine kada je uvedena trica) postepeno rastao broj poena po timu po sezoni što može biti dokaz evolucije u tom segmentu igre - igrači postaju sve vještiji u zabijanju trica.


\bigbreak
```{r}
players.bySeasons %>% select(Year, Player, G, Pos, X3P) %>%
                  na.omit %>%
                  filter(grepl("SG", Pos)) %>%
                  filter(Year < 1984 & X3P > 0) %>%
                  group_by(Player) %>%
                  summarize(X3P = sum(X3P)) -> sg
sg.prosjek = sum(sg$X3P) / length(sg$X3P)

players.bySeasons %>% select(Year, Player, G, Pos, X3P) %>%
                  na.omit %>%
                  filter(grepl("C", Pos)) %>%
                  filter(Year > 2012 & X3P > 0) %>%
                  group_by(Player) %>%
                  summarize(X3P = sum(X3P)) -> centers

c.prosjek = sum(centers$X3P) / length(centers$X3P)
hist(sg$X3P, main = "Razdioba pogođenih trica SG", xlab = "Ukupan broj pogođenih trica po igraču - SG (1979-1984)", ylab = "Frekvencija", col = graph.col)
summary(sg$X3P)
```
\bigbreak
```{r}
hist(centers$X3P, main = "Razdioba pogođenih trica C", xlab = "Ukupan broj pogođenih trica po igraču - C (2012-2017)", ylab = "Frekvencija", col = graph.col)

summary(centers$X3P)
```


\newpage
# 3. Tko je bolji šuter za tri i dva poena: 'Center' ili 'Shooting Guard'? 
Općenito zanima nas koja je od navedenih pozicija bolji šuter. No, osim toga zanimljivo bi bilo vidjeti je li ta pozicija nužno bolja i za dva i za tri poena. Možda je jedna pozicija uspješnija od druge samo u pogledu trica, ali je zato ova druga bolja za pogotke koji vrijede 2 poena. Pogledajmo najprije kako izgledaju podatci i kojim tehnikama možemo pribjeći.
```{r}
# Before we start with anything we should define levels of significance.
f.alpha = 0.05
t.alpha = 0.05

# Utility function used for grouping players and calculating their 3 and 2 point shots.
group.by = function(players) {
  players <- players %>% group_by(Player) %>%
             summarize(X3PPG = sum(X3P)/sum(X3PA),
                       X3PA = sum(X3PA),
                       X2PPG = sum(X2P)/sum(X2PA),
                       X2PA = sum(X2PA))
  return (players)
}

# Load both centers and shooting guards but only ones that have actually tried
# to take a shot (both 2 point and 3 point shot).
players.bySeasons %>% select(Player, Pos, X3P, X3PA, X2P, X2PA) %>% 
                  na.omit %>% 
                  filter(X3PA > 0 & X2PA > 0) -> players
centers  = group.by(players[ grep("C", players$Pos),])
s.guards = group.by(players[grep("SG", players$Pos),])
```
$Q-Q$ plot i histogram za postotak pogođenih 2 point šuta za 'Center' i 'Shooting Guard':
\bigbreak
```{r, echo=FALSE}
# Plot histogram and Q-Q plot in order to check for data normality. If data is not
# normally distributed we cannot use parametric tests such as t-test.
hist(centers$X2PPG, xlab = "Postotak pogođenih 2 poena", ylab = "Frekvencija", main = "Centri", col = graph.col)
```
\bigbreak
```{r}
boxplot(centers$X2PPG, main = "Centri - 2P%", col = graph.col)
```
\bigbreak
```{r}
nan = qqPlot(standardize(centers$X2PPG), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - centri 2P%", col = graph.col)
```
\bigbreak
```{r}
hist(s.guards$X2PPG, xlab = "Postotak pogođenih 2 poena", ylab = "Frekvencija", main = "Shooting guards", col = graph.col)
```
\bigbreak
```{r}
boxplot(s.guards$X2PPG, main= "Shooting guards - 2P%", col = graph.col)
```
\bigbreak
```{r}
nan = qqPlot(standardize(s.guards$X2PPG), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - shooting guards 2P%")
```
\newpage
```{r}
# Plot histogram and Q-Q plot in order to check for data normality. If data is not
# normally distributed we cannot use parametric tests such as t-test.
hist(centers$X3PPG, xlab = "Postotak pogođenih trica", ylab = "Frekvencija", main = "Centri", col = graph.col)
```
\bigbreak
```{r}
boxplot(centers$X3PPG, main = "Centri - 3P%", col = graph.col)
```
\bigbreak
```{r}
nan = qqPlot(standardize(centers$X3PPG), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - centri 3P%", col = graph.col)
```
\bigbreak
```{r}
hist(s.guards$X3PPG, xlab = "Postotak pogođenih trica", ylab = "Frekvencija", main = "Shooting guards", col = graph.col)
```
\bigbreak
```{r}
boxplot(s.guards$X3PPG, main= "Shooting guards - 3P%", col = graph.col)
```
\bigbreak
```{r}
nan = qqPlot(standardize(s.guards$X3PPG), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - shooting guards 3P%")
```

\newpage
Iz prikazanih grafova možemo zaključiti da parametarski $t$-test možemo koristiti samo za postotak realizacije 2 point šuta. Stoga, pogledajmo najprije uz pomoć $f$-testa možemo li pretpostaviti jednakost varijanci za postotke realizacije 2 point šuta pozicija 'Center' i 'Shooting Guard'. Na koncu, provedimo sam $t$-test.
```{r}
# First we test for the equality of variances, then we perform a t-test.
var2ppg.equal = var.test(centers$X2PPG, s.guards$X2PPG, alternative = "two.sided")$p.value > f.alpha
t.test(x = centers$X2PPG, y = s.guards$X2PPG, alternative = "greater", mu = 0,
       var.equal = var2ppg.equal, conf.level = 1-t.alpha)
```
Zaključujemo kako na razini značajnosti od 5% možemo tvrditi da je postotak realizacije 2 point šuta veći kod pozicije 'Center' u odnosu na poziciju 'Shooting Guard'.

U prethodnom koraku rekli smo kako ne možemo koristiti parametarski $t$-test za postotak realizacije 3 point šuta jer ne vrijedi pretpostavka normalnosti podataka. No, možemo si pomoći koristeći neparametarski test Bootstrap.
```{r}
# Define total number of iterations for function 'bs.interval'.
replica.count = 1E5

# Since we have two populations the idea is to bootstrap first and second population
# and then because we are perfroming a test whether percentage of 3 point shots of guards
# is greater than for centers we will be substracting one from each other.
# Finally, we calculate confidence interval and the lower bound in order to decide whether
# we reject null hypotesis that percentages are equal or not.
bs.interval(
  x = s.guards$X3PPG,
  y = centers$X3PPG,
  B = replica.count,
  alpha = t.alpha,
  alternative = "greater"
) -> interval
print.bs.interval(interval)
mean(s.guards$X3PPG)
mean(centers$X3PPG)
```
Nakon provedenog testa vidimo da 0 'nije upala' u interval povjerenja pa možemo uz razinu značajnosti od 5% tvrditi kako pozicija 'Shooting guard' zaista ima veći postotak realizacije 3 point šuta u odnosu na poziciju 'Center'.


\newpage
# 4. Utječe li širina raspona ruku na efikasnost u obrani? 
Kako bismo odgovorili na ovo pitanje moramo odrediti kako ćemo definirati efikasnost obrane. NBA statistika nam ovdje značajno pomaže sa podatkom DWS (Defensive Win Shares). To je složeni podatak koji uzima u obzir nekoliko ostalih podataka kao što su broj pogodaka, posjed lopte te neke timske podatke te na osnovu njih računa vlastitu vrijednost. Pokušat ćemo linearnom regresijom provjeriti jesu li ova dva podatka (wingspan i DWS) linearno povezani.
```{r}
read.csv("nba-players-stats/player_wingspan_data.csv") -> wingspan
wingspan$Wingspan.m = conv_unit(wingspan$Wingspan.in, from="inch", to="m")
```

```{r}
nan = qqPlot(standardize(wingspan$Wingspan.m), xlab = "Kvantili normalne distribucije", ylab = "",main = "Q-Q plot - Raspon ruku", col = graph.col)
```
\bigbreak
```{r}
nan = qqPlot(standardize(wingspan$DWS), xlab = "Kvantili normalne distribucije", ylab = "",main = "Q-Q plot - DWS", col = graph.col)
```
\bigbreak
```{r}
hist(wingspan$Wingspan.m, xlab = "Raspon ruku", ylab = "Frekvencija", main = "Histogram raspona ruku", col = graph.col)
```

```{r}
hist(wingspan$DWS, xlab = "DWS", ylab = "Frekvencija", main = "Histogram DWS", col = graph.col)
```

\bigbreak
```{r}
plot(wingspan$DWS~wingspan$Wingspan.m, xlab = "prosječni wingspan", ylab = "prosječni DWS", col = graph.col)
```
\bigbreak
```{r}
fit = lm(wingspan$DWS~wingspan$Wingspan.m)
summary(fit)
```
Na osnovu dobivenih rezultata zaključujemo da navedene podatke ne možemo nikako povezati. Kada malo bolje razmislimo, veći raspon ruku omogućuje veću pokrivenost terena oko sebe, međutim, on također i unosi potencijalne negativne učinke kao što su tromost, manju ravnotežu i sl. Zbog toga ova statistika i nije toliko začuđujuća.


\newpage
# 5. Hall of Fame igrači - najbolji baš u svemu?
Jedno od zanimljivh pitanja koje se postavlja jest jesu li igrači koji su dospjeli u Košarkašku Kuću slavnih bolji od ostalih igrača. Konkretno ovdje ćemo se osvrnui na postotak realizacija trica. Na prvi pogled, osoba koja nije previše upućena u svijet košarke bi mogla tvrditi kako su slavni igrači zasigurno bolji. Ovim testom pokušati ćemo pokazati baš suprotno. Razdvojit ćemo igrače koji su u Košarkaškoj Kući od onih koji nisu. Najprije ćemo provesti $f$-test kako bi znali možemo li pretpostaviti jednakost varijanci, zatim crtamo $Q-Q$ plot kojim provjeravamo jesu li zadovoljene pretpostavke o normalnosti populacija te konačno provodimo $t$-test.
```{r}
# Before we start with anything we should define levels of significance.
f.alpha = 0.05
t.alpha = 0.05

# Load players and their 3P%. Important note: players have to more than one attempt
# to shoot a 3 point. This way we remove a lot of outliers that would have 100%.
# Aslo, only players that have scored at least one three point are taken into account.
players.bySeasons %>% select(Player, X3P, X3PA) %>%
                  na.omit %>%
                  group_by(Player) %>% 
                  summarise(three.p = sum(X3P)/sum(X3PA), all.attempts = sum(X3PA)) %>%
                  filter(all.attempts > 1 & three.p > 0) -> all.players

# Divide players into 2 groups: Hall of Fame players and ones that are not.
HOF.players = all.players[grep("\\*", all.players$Player),]
NOR.players = setdiff(all.players, HOF.players)

# Before performing a t-test we should first check for the equality of the variances.
# In case there is sufficient evidence to support the claim that variances are equal,
# then we can more easily reject the null hypothesis that there is no difference in
# three point percentage between Hall of Fame players and ones that are not in Hall.
var.eq.p.value = var.test(NOR.players$three.p, HOF.players$three.p, alternative = "two.sided")$p.value
```

Boxplot te $Q-Q$ plot za igrače koji nisu dospjeli u Košarkašku Kuću slavnih i one koji jesu:
\bigbreak
```{r}
# Next step is to check for normality of the data. Otherwise we cannot perform t-test.
boxplot(NOR.players$three.p, main = "Postotak realizacije trica - Ne-HOF igrači", col = graph.col)
```
\bigbreak
```{r}
boxplot(HOF.players$three.p, main = "Postotak realizacije trica - HOF igrači", col = graph.col)
```
\newpage
```{r}
nan = qqPlot(standardize(NOR.players$three.p), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - Ne-HOF igrači 3P%")
```

\bigbreak
```{r}
nan = qqPlot(standardize(HOF.players$three.p), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - HOF igrači 3P%")
```
\newpage
Rezultati $t$-testa:
```{r}
# Finally we perform a t-test. Bear in mind that we are actually trying to test
# something that might be counterintuitive at first. Here we are trying to prove
# that players that are in Hall of Fame have LOWER percentage of 3 point scores
# compared to the ones that are not in Hall of Fame.
t.test(x = NOR.players$three.p, y = HOF.players$three.p, alternative = "greater", mu = 0,
       var.equal = var.eq.p.value > f.alpha, conf.level = 1-t.alpha)
```
Nakon provedenog $t$-testa možemo zaključiti na razini značajnosti od 5% kako igrači koji su dospjeli u Košarkašku Kuću slavnih imaju manji postotak pogođenih 3 point šuta u odonsu na igrače koji nisu u Košarkaškoj Kući slavnih. 


\newpage
# 6. Fakultet prije NBA karijere? Da ili ne? 
Poznato nam je da mnogi najbolji NBA igrači nisu završili fakultet. Neki od njih su Kobe Brynat, Kevin Garnett, LeBron James, Tracy McGrady te mnogi drugi, stoga bi bilo zanimljivo istražiti jesu li općenito ti igrači bolji od onih koji su se školovali na fakultetima. Uglavnom, isplati li se budućim NBA igračima završiti fakultet ili odmah započeti NBA karijeru.Najprije ćemo vizualizirati podatke kako bi dobili ideju što možemo učiniti po pitanje provjere jesu li doista igrači bez završenog fakulteta bolji od onih koji su ga završili.
```{r, include=FALSE}
# First we define a level of significance for Bootstrap testing.
bs.alpha = 0.05

# Utility function for extracting interesting player characteristics.
processPlayers <- function(players) {
  return (players %>% group_by(name) %>%
                  summarise(PTS=sum(PTS)/sum(G), TRB=sum(TRB)/sum(G)) %>%
                  na.omit)
}

# Load all important data for analysis.
players.bySeasons %>% select(name = Player, G, Pos, PTS, TRB) %>%
                      na.omit -> all.players
read.csv("nba-players-stats/player_data.csv") %>% select(name, college) %>%
                      left_join(all.players) -> all.players

# Filter players with finished college.
all.players %>% filter(college != '') -> college.players
setdiff(all.players, college.players) -> non.college.players

# Extract interesting characteristics.
college.players <- processPlayers(college.players)
non.college.players <- processPlayers(non.college.players)
```
\bigbreak
```{r}
xlab = c("S fakultetom", "Bez fakulteta")
colors = c("green4", "red4")

hist(college.players$PTS, col = colors[1], main = "Poeni (igrači s fakultetom)", xlab = "Poeni", ylab = "Frekvencija")
```
\bigbreak
```{r}
hist(college.players$TRB, col = colors[1], main = "Skokovi (igrači s fakultetom)", xlab = "Skokovi", ylab = "Frekvencija")
```
\bigbreak
```{r}
hist(non.college.players$PTS, col = colors[2], main = "Poeni (igrači bez fakulteta)", xlab = "Poeni", ylab = "Frekvencija")
```
\bigbreak
```{r}
hist(non.college.players$TRB, col = colors[2], main = "Skokovi (igrači bez fakulteta)", xlab = "Skokovi", ylab = "Frekvencija")
```
\bigbreak
```{r}
boxplot(college.players$PTS, non.college.players$PTS, names = xlab, ylab = "Poeni po utakmici", col = colors)
```
\bigbreak
```{r}
boxplot(college.players$TRB, non.college.players$TRB, names = xlab, ylab = "Skokovi po utakmici", col = colors)
```
\bigbreak
```{r}
nan = qqPlot(college.players$PTS, col = colors[1], main = "Poeni", xlab = "Kvantili normalne distribucije", ylab = "")
```
\bigbreak
```{r}
nan = qqPlot(college.players$TRB, col = colors[1], main = "Skokovi", xlab = "Kvantili normalne distribucije", ylab = "")
```
\bigbreak
```{r}
nan = qqPlot(non.college.players$PTS, col = colors[2], main = "Poeni", xlab = "Kvantili normalne distribucije", ylab = "")
```
\bigbreak
```{r}
nan = qqPlot(non.college.players$TRB, col = colors[2], main = "Skokovi", xlab = "Kvantili normalne distribucije", ylab = "")
```
\newpage
Vidimo da su igrači bez završenog fakulteta ipak malo bolji i to i u broju poena i broju skokova po utakmici. Također, vidimo da podatci nisu normalno distribuirani pa ćemo provesti Bootstrap metodu testiranja s intervalom pouzdanosti. Konkretno, testirati ćemo hipotezu da su obje populacije igrača jednako dobre (i u broju poena i u skokovima) nasuprot alternative da su igrači bez završenog fakulteta bolji. Zbog zakrivljenosti distribucija umjesto srednje vrijednosti koristit ćemo medijan jer je on u tom slučaju bolji pokazatelj sredine distribucije.


```{r}
replica.count = 10000

# Test and print results for points.
message("Bootstrap test za poene... ")
print.bs.interval(bs.interval(
  x = non.college.players$PTS,
  y = college.players$PTS,
  alternative = "greater",
  alpha = bs.alpha,
  B = replica.count,
  f = median)
)

message("\nBootstrap test za skokove... ")
# Test and print results for total rebound.
print.bs.interval(bs.interval(
  x = non.college.players$TRB,
  y = college.players$TRB,
  alternative = "greater",
  alpha = bs.alpha,
  B = replica.count,
  f = median)
)
```
Uz pomoć Bootstrap metode možemo na razini značajnosti $\alpha = 0.05$ tvrditi kako su igrači bez završenog fakulteta bolji samo u broju skokova po utakmici. Ipak, valja primijetiti kako je razlika izrazito mala i kako možda nije dovoljno značajna da bi donosili nekakve čvrste, kategoričke odluke. Uprkos tome, test ipak ima značaj jer bi imalo smisla tvrditi da su igrači koji su se dodatno obrazovali na fakultetu bolji zbog dodatnog stečenog znanja, a mi smo s testiranjem pokazali ne samo da su jednaki kao oni bez završenog fakulteta nego čak i lošiji.


\newpage
# 7. Jesu li pozicije igrača podjednako raspodijeljene u Kući slavnih?
Jesu li se pozicije igrača koji su dospjeli u Košarkašku Kuću slavnih ravnomjerno raspodijeljene? Točnije, zanima nas jesu li određene pozicije popularnije u smislu da igrači koji igraju na tim pozicijama ostvaruju takve rezultate i uspjehe da to u konačnici rezultirati ulaskom u Košarkašku Kuću slavnih. Koristit ćemo $\chi^2$-test odnosno test prilagodbe modela podatcima.
```{r}
# Utility function used for extracting number of players for certain position.
pos.len = function(pos, players) {
  players[grep(pos, players$Pos),] %>% distinct(Player) -> pos.players
  return(length(pos.players$Player))
}

# Extract Hall of Fame players.
players.bySeasons %>% select(Player, Pos) %>% 
                  na.omit %>%
                  filter(grepl("\\*", Player)) -> HOF.players

# Create a vector which actually represents a distribution of positions of Hall of Fame players.
dist.of.pos = c(pos.len("PG", HOF.players),
                pos.len("SG", HOF.players),
                pos.len("SF", HOF.players),
                pos.len("PF", HOF.players),
                pos.len("C",  HOF.players))
num.of.pos = length(dist.of.pos)

# Prepare a uniform distribution and contingency table in order to perform a chi-squred test.
uniform = rep(1, num.of.pos) * (sum(dist.of.pos) / num.of.pos)
table = rbind(dist.of.pos, uniform)
```

Rezultati $\chi^2$-testa te raspodjela Hall of Fame igrača po pozicijama:
```{r}
chisq.test(table)
```
\bigbreak
```{r}
barplot(dist.of.pos, names.arg = pos.labels, col = pos.colors)
```
\bigbreak
```{r}
pie(dist.of.pos, main = "Raspodjela Hall of Fame igrača po pozicijama", labels = pos.labels, col = pos.colors)
```


\newpage
# 8. Vizualizacija fizičkih karakteristika igrača po pozicijama
U prošlom dijelu smo testirali je li raspodjela pozicija igrača koji su dospjeli u Košarkašku kuću slavnih ravnomjerna. Sada ćemo promatrati fizičke karakteristike igrača kod pojedinih pozicija. Preciznije, zanima nas kakva je distribucija visina i težina za pojedine pozicije. To ćemo ilustrirati na 2 dijagrama (jedan za visinu, drugi za težinu) gdje će istovremeno biti 5 pravokutnih dijagrama s izdancima - za svaku poziciju po jedan.
```{r}
# Utility function used for extracting players for certain position.
by.pos = function(pos, players) {
  return (players[grep(pos, players$Pos),])
}

# First we extract players that have played exclusively one position.  
# Then, we extract players by certain positions.
players.bySeasons %>% select(Player, Pos) %>% 
                      na.omit %>%
                      filter(!grepl("\\-", Pos)) %>%
                      distinct(Player, Pos) %>%
                      left_join(players.bySeasons.info) %>%
                      distinct(Player, Pos, height, weight) %>%
                      na.omit -> all.players

# Extract players by their position. One should bear in mind that only
# these exact positions will be extracted. Possible positions like 'G'
# or 'F' WILL be ommited.
pg = by.pos("PG", all.players)
sg = by.pos("SG", all.players)
sf = by.pos("SF", all.players)
pf = by.pos("PF", all.players)
c  = by.pos("C", all.players)

boxplot(pg$height, sg$height, sf$height, pf$height, c$height, names = pos.labels, ylab = "Visina", col = pos.colors)
```
\bigbreak
```{r}
boxplot(pg$weight, sg$weight, sf$weight, pf$weight, c$weight, names = pos.labels, ylab = "Težina", col = pos.colors)
```


\newpage
# 9. Postoji li povezanost između broja realiziranih šuteva koji nose 2 i 3 poena?
Konkretno, zanima nas postoji li čvrsta LINEARNA povezanost u smislu da oni igrači koji imaju više pogodaka za 2 poena nužno imaju i više pogođenih trica. 
```{r}
players <- players.bySeasons %>%
           select(Player, X3P, X2P, Pos) %>%
           na.omit %>%
           filter(grepl("PG", Pos)) %>%
           group_by(Player) %>%
           summarize(X3sum = sum(X3P), X2sum = sum(X2P))
```

Najprije ćemo vizualizirati podatke kako bi vidjeli postoji li mogućnost povezivanja varijabli linearnim modelom.
```{r}
plot(players$X3sum~players$X2sum,
  main = "2p vs 3p",
  xlab = "Broj 2 point pogodaka",
  ylab = "Broj 3 point pogodaka",
  col = graph.col
)
```
Kao što vidimo podatci su prilično "rasprešni" i možemo reći da ne postoji pretjerana (linearna) povezanost između broja 2 point pogodaka i trica. No, u to se možemo i dodatno uvjeriti pomoću linearne regresije.
Rezultati regresije na sljedećoj stranici:
\newpage
```{r}
fit = lm(players$X3sum ~ players$X2sum)
summary(fit)
```
Linearna korelacija je premala kako bi mogli govoriti o čvrstoj povezanosti između šuta za 2 i 3 poena što nam dodatno potvđuje ono što smo i nasulutili iz grafa.


\newpage
# 10. Povezanost duljine karijere i broja utakmica igrača.
Cilj ovog zadatka je konstruirati dovoljno dobar model koji će na osnovu broja utakmica igrača predvidjeti koliko dugo je trajala karijera igrača. Ideja je sljedeća: najprije ćemo podijeliti početni skup igrača na onaj za učenje i ispitavanje (provjere točnosti) modela. Zatim ćemo pristupu konstrukcije modela pristupiti na 2 načina: linearnom regresijom te strojnim učenjem odnosno pomoću umjetnih neuronskih mreža.
```{r}
players.bySeasons %>% select(Player, G) %>%
                      na.omit %>%
                      group_by(Player) %>% 
                      summarise(Games=sum(G)) -> players.with.g

# Load second dataset
read.csv("nba-players-stats/player_data.csv") %>% 
                      select(Player=name, year_start, year_end) %>% 
                      na.omit -> all.players

all.players$duration <- all.players$year_end - all.players$year_start +1
merge(players.with.g, all.players) -> all.players

threshold = 0.9*length(all.players$Player)
all.players.train <- all.players[1:threshold,]
all.players.test <- setdiff(all.players, all.players.train)

fit = lm(all.players.train$duration ~ all.players.train$Games)
```

\bigbreak
```{r}
plot(all.players.train$duration~ all.players.train$Games, xlab = "Broj utakmica igrača", ylab = "Trajanje karijere igrača (god.)", main="Trajanje karijere u ovisnosti o broju utakmica")
lines(all.players.train$Games, fitted(fit), col="red")
```

```{r}
residual = resid(fit)
plot(all.players.train$Games, residual, ylab="Reziduali", xlab="Broj utakmica", main="Analiza reziduala")
```
\newpage
Već pri analizi samih grafova možemo zaključiti kako postoji dosta čvrsta veza između broja utakmica i trajanja karijere igrača. Početnu hipotezu potvrđuje i relativno visok Pearsonov koeficijent korelacije (81.13%) što je relativno zadovoljavajuće s obzirom na stvarne podatke.

Rezultati regresije:
```{r}
summary(fit)
```



Nakon provedenih $t$-testova za odječak na osi y - $\beta_0$ te koeficijenta smjera - $\beta_1$ možemo zaključiti kako su oba koeficijenta različita od 0 ($p-vrijednost < 10^{-10}$).
$\beta_0 = 1.8508$
$\beta_1 = 0.0119$
```{r}
intercept = summary(fit)$coefficients[1,1]
slope = summary(fit)$coefficients[2,1]
```

Točnost modela provjeravamo na skupu za ispitivanje. Kao mjeru pogreške uzet ćemo $MSE$ (engl. Mean Square Error) odnosno srednju kvadratnu pogrešku. Ispada da je navedena mjera jednaka 2.73 godine što je 14.4% od ukupnog raspona trajanja karijera igrača u skupu za ispitivanje. 
```{r}
all.players.test$Error = (intercept + all.players.test$Games*slope) - all.players.test$duration
hist(all.players.test$Error, xlab = "Pogreška modela na skupu za testiranje", ylab = "Frekvencija", main = "Histogram pogreške modela na skupu za ispitivanje", col = graph.col)
```
\bigbreak
```{r}
all.players.test$SQE = all.players.test$Error^2
MSE = sum(all.players.test$SQE) / length(all.players.test$Error)
MSE = MSE/(max(all.players.test$duration)-min(all.players.test$duration))
```
\bigbreak
```{r}
nan = qqPlot(standardize(all.players.test$Error), xlab = "Kvantili normalne distribucije", ylab = "", main = "Q-Q plot - distribucija pogrešaka na skupu za testiranje", col = graph.col)
```
\newpage
Konačno, kako bi pokušali nači optimalnu funkciju preslikavanja između broja utakmica i trajanja karijere, problem smo pokušali riješiti koristeći umjetne neuronske mreže. Konkretno, prilagođavanje težina u neuronskim mrežama izvedeno je genetskim populacijskim algoritmom sa sljedećim parametrima:  
- veličina populacije: 30  
- broj elitnih jedinki: 5   
- vjerojatnost mutacije: 5%   
- broj iteracija: 10 000  

Što se tiče same arhitekture mreže, sastoji se od 3 skrivena sloja:    
1. ulazni sloj (1 neuron - broj utakcima)   
2. potpuno povezan sloj (7 neurona)    
3. aktivacijska funkcija (ReLU)    
4. potpuno povezan sloj (5 neurona)    
5. potpuno povezan sloj (3 neurona)    
6. izlazni sloj (1 neuron - trajanje karijere u godinama)    
   
Zanimljivo je da je neuronska mreža bila nešto bolja u predikciji rezultata, konkretno dobivena je pogreška od 2.5 godine na skupu za ispitivanje.


\newpage
# 11. Usporedba najboljih igrača u povijesti NBA lige (G.O.A.T. debate)
I tako, došli smo do kraja gdje ćemo se dotaknuti najškakljivije teme u NBA ligi a to je tko je najbolji igrač ikada? Navijači su podijeljeni otprilike ravnoporavno i svaka grupa je naoružana validnim argumentima zašto baš njihov miljenik zaslužuje titulu najboljeg igrača u povijesti NBA lige. U ovom dijelu nećemo dati odgovor na spomenuto pitanje jer bi to bilo relativno amaterski da na par statisčki zaključaka donesemo konačni sud. Umjesto toga prezentirat ćemo podatke i ostaviti čitatelju da sam procijeni tko je najbolji.
```{r, echo = F, warning=FALSE}
read.csv("players/pre/kobe_career_pre.csv")%>% select(PTS, AST, TRB, TOV, STL, FG., X3P., GmSc) %>% na.omit -> bryant
read.csv("players/pre/jordan_career_pre.csv")%>% select(PTS, AST, TRB, TOV, STL, FG., X3P., GmSc) %>% na.omit -> jordan
read.csv("players/pre/james_career_pre.csv")%>% select(PTS, AST, TRB, TOV, STL, FG., X3P., GmSc) %>% na.omit -> james
read.csv("players/pre/durant_career_pre.csv")%>% select(PTS, AST, TRB, TOV, FG., STL, X3P., GmSc) %>% na.omit -> durant

# Calculate basic stats
points<-c(mean(bryant$PTS), mean(jordan$PTS), mean(james$PTS), mean(durant$PTS))
asists<-c(mean(bryant$AST), mean(jordan$AST), mean(james$AST), mean(durant$AST))
rebounds<-c(mean(bryant$TRB), mean(jordan$TRB), mean(james$TRB), mean(durant$TRB))
turnovers<-c(mean(bryant$TOV), mean(jordan$TOV), mean(james$TOV), mean(durant$TOV))
steals<-c(mean(bryant$STL), mean(jordan$STL), mean(james$STL), mean(durant$STL))
plus.minus<-c(mean(bryant$GmSc), mean(jordan$GmSc), mean(james$GmSc), mean(durant$GmSc))

nba.titles<-c(5,6,3,2)
mvp.titles<-c(1,5,4,1)
all.star.selection <-c(18,14,15,10)
scoring.titles<-c(2,10,1,4)
```


## Prikaz kategorijskih podataka
Prikaz najbitnijh karakterstika po kategorijama. Ovaj prikaz je površni te dosta grubo predočava situaciju.
\bigbreak
```{r, echo = F, warning=FALSE}
custom.ggplot(
  list(bryant, jordan, james, durant),
  c("Bryant", "Jordan", "James", "Durant"),
  c("#a00e0e", "#e5aa22", "#2260e5", "#330547"),
  c("Points", "Asists", "Rebounds", "Turnovers", "Steals", "+/-"),
  c(points, asists, rebounds, turnovers, steals, plus.minus)
  )+
  ylab("Prosječan iznos po utakmici") + 
  xlab("Kategorije")+
  ggtitle("Prikaz efikasnosti igrača po kategorijama") +
  theme(plot.title = element_text(hjust = 0.5))
```


## Individualni i timski uspjesi
```{r, echo = F, warning=FALSE}
custom.ggplot(
  list(bryant, jordan, james, durant),
  c("Bryant", "Jordan", "James", "Durant"),
  c("#a00e0e", "#e5aa22", "#2260e5", "#330547"),
  c("NBA Champ.", "MVP Titles", "All Star", "Scoring Champ."),
  c(nba.titles, mvp.titles, all.star.selection, scoring.titles)
  )+
  ylab("Frekvencija") + 
  xlab("Kategorije")+
  ggtitle("Prikaz individualnih uspjeha igrača") +
  theme(plot.title = element_text(hjust = 0.5))
```


## Šuterske karakterstike igrača
```{r, echo = F, warning=FALSE}

bryant$ID <- seq.int(nrow(bryant))
jordan$ID <- seq.int(nrow(jordan))
james$ID <- seq.int(nrow(james))
durant$ID <- seq.int(nrow(durant))

jordan$Legend = "Jordan"
bryant$Legend ="Bryant"
james$Legend="James"
durant$Legend="Durant"
goat.players = rbind(bryant, jordan, james, durant)

vline.data <- data.frame(ID=c("Bryant", "Jordan", "James", "Durant"),
                   means=c(mean(bryant$PTS), mean(jordan$PTS),mean(james$PTS),mean(durant$PTS)) )

ggplot(goat.players, aes(x=PTS, colour=Legend)) +
  geom_density(aes(y = ..count..))+
  geom_vline(data=vline.data, aes(xintercept=means, colour=ID),linetype="dashed", size=0.5)+
  ylab("Frekvencija") + 
  xlab("Poena po utakmici")+
  ggtitle("Razdioba poena za sve utakmice") +
  theme(plot.title = element_text(hjust = 0.5))

```
\bigbreak
Iz prethodne slike ne možemo jasno vidjeti što se događa u repu distribucije koji je također bitan. Zbog toga u sljedećem prikazu povećavamo prikaz repova. Iz slike vidimo da zapravo Kobe Bryant i Michael Jordan imaju najviše utakmica s najviše zabijenih koševa. 
```{r, echo = F, warning=FALSE}
kobe_zoom <- bryant[bryant$PTS > 40,]
jordan_zoom <- jordan[jordan$PTS > 40,]
james_zoom <- james[james$PTS > 40,]
durant_zoom <- durant[durant$PTS > 40,]
goat.players = rbind(kobe_zoom, jordan_zoom, james_zoom, durant_zoom)

```
\bigbreak
```{r, echo = F, warning=FALSE}
ggplot(goat.players, aes(x=PTS, colour=Legend)) +
  geom_density(aes(y = ..count..))+
  ylab("Frekvencija") + 
  xlab("Poena po utakmici")+
  ggtitle("Razdioba poena za sve utakmice") +
  theme(plot.title = element_text(hjust = 0.5))
```

\bigbreak
No isto tako bitan je postotak pogođenih šuteva za dva i tri poena.
\bigbreak
```{r, echo = F, warning=FALSE}
boxplot(bryant$FG., jordan$FG., james$FG., durant$FG.,
        names = c("Bryant", "Jordan", "James", "Durant"),
        ylab = "Postotak šuta za sve utakmice (FG%)",
        col = pos.colors)

```
\bigbreak
```{r}
boxplot(bryant$X3P., jordan$X3P., james$X3P., durant$X3P.,
        names = c("Bryant", "Jordan", "James", "Durant"),
        ylab = "Postotak šuta za sve utakmice (3P%)",
        col = pos.colors)
```


