---
title: "Projekt iz kolegija: Statistička analiza podataka"
subtitle: "Statistika NBA igrača"
author: "Disperzanti - Vlado Galić, Tin Komerički, Marino Voćanec"
date: "12/05/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(dplyr)
require(gridExtra)
require(car)
require(bootstrap)
set.seed(42)
players.bySeasons = read.csv("nba-players-stats/Seasons_Stats.csv")
players.bySeasons.info = read.csv("nba-players-stats/Players.csv")
```


```{r, utility functions}

bs.interval <- function(x, y = NULL, B = 1E5, alpha = 0.05, alternative = "two.sided", f = mean) {
  boot = bootstrap(x, B, f)$thetastar
  if(!is.null(y)) {
    boot = boot - bootstrap(y, B, f)$thetastar
  }
  boot = sort(boot)
  
  if(alternative == "two.sided") {
    return (c(boot[B*alpha/2], boot[B*(1-alpha/2)]))
    
  } else if(alternative == "greater") {
    return (c(boot[B*alpha], +Inf))
    
  } else if(alternative == "less") {
    return (c(-Inf, boot[B*(1-alpha)]))
  }
  
  return (NULL)
}

```



# TODO
# 1. Jesu li su viši centri nužno i bolji skakači?
Centar je igrač koji većinu svog vremena provodi pod košem vrebajući skokove. Zbog toga je zanimljivo proučavati da li je visina igrača bitan parametar za skupljanje skokova? Prirodno bi bilo očekivati da će visina igrači pozitivno utjecati na količinu skokova.

```{r, echo=FALSE}
# Load seasons stats
players.bySeasons %>% select(Year,G,Player,Pos,TRB) -> players

# Remove NA
players = players[complete.cases(players),]

#only centers
centers = players[grep("C", players$Pos),]

# Calculate Rebound Per Game
centers %>% group_by(Player)  %>% summarize(RPG = sum(TRB)/sum(G)) -> centers

# Load personal information of players
players.bySeasons.info %>% select(Player, height, weight)-> players.info

# Inner join
centers = merge(centers, players.info)

# Seperate higher and lower centers by mean
centers.height.mean = mean(centers$height)
plot(centers$height, centers$RPG)
fit = lm(height~RPG, centers)
summary(fit)
centers[centers$height >= centers.height.mean,] -> higher.centers
centers[centers$height < centers.height.mean,] -> lower.centers
```

Razdioba visina i skokova svih centara:
```{r}
summary(centers)
hist(centers$RPG)
hist(centers$height)
#plot(centers$height, centers$RPG, type="p")
```

Razdioba nižih i viših centara:
```{r}
summary(higher.centers)
summary(lower.centers)
hist(higher.centers$RPG)
hist(lower.centers$RPG)
hist(lower.centers$height)
hist(higher.centers$height)
```



# TODO
# 2. Da li je bolje evoluirao napad ili odbrana NBA igrača?
Za očekivati je da svaka igra/sport, pa tako i košarka, evoluira. Ako je napad igrača puno bolji od odbrane onda će se prosječno postizati puno više koševa po utakmici, u protivnom će biti jako malo koševa. Naš zadatak je istražiti da li se tijekom povijesti jedan od ta dva dijela igre značajno promijenio.
```{r, echo=FALSE}
read.csv("nba-players-stats/Seasons_info_full.csv") -> seasons
read.csv("nba-players-stats/Seasons_info.csv") -> seasons.teams.games

# Inner join
seasons = merge(seasons, seasons.teams.games)
seasons

# Cut data
#seasons.info[seasons.info$Season > 1990,] -> seasons.info
```

Broj koševa po NBA sezoni:
```{r}
#plot(seasons$Year, seasons$Games, type="p")
#plot(seasons$Year, seasons$Teams)
plot(seasons$Year, seasons$PTS)

```



3. Tko je bolji šuter za tri i dva poena: 'Center' ili 'Shooting Guard'?
# @Vlado molim dodati neki malo bolji i opsežniji opis za ovaj problem jer nemam baš ideje što tu napisati.
```{r}
# Before we start with anything we should define levels of confidence.
f.alpha = 0.05
t.alpha = 0.05

# Utility function used for grouping players and calculating their 3 and 2 point shots.
group.by = function(players) {
  players <- players %>% group_by(Player) %>%
             summarize(X3PPG = sum(X3P)/sum(X3PA),
                       X3PA = sum(X3PA),
                       X2PPG = sum(X2P)/sum(X2PA),
                       X2PA = sum(X2PA))
  return (players)
}

# Load both centers and shooting guards but only ones that have actually tried
# to take a shot (both 2 point and 3 point shot).
players.bySeasons %>% select(Player, Pos, X3P, X3PA, X2P, X2PA) %>% 
                  na.omit %>% 
                  filter(X3PA > 0 & X2PA > 0) -> players
centers  = group.by(players[ grep("C", players$Pos),])
s.guards = group.by(players[grep("SG", players$Pos),])
```

$QQ$-plot i histogram za postotak pogođenih 2 point šuta za 'Center' i 'Shooting Guard':
```{r}
# Plot histogram and QQ-plot in order to check for data normality. If data is not
# normally distributed we cannot use parametric tests such as t-test.
hist(centers$X2PPG)
boxplot(centers$X2PPG, main="Centers - 2 poena")
qqPlot(centers$X2PPG)
hist(s.guards$X2PPG)
boxplot(s.guards$X2PPG, main="Shooting guards - 2 poena")
qqPlot(s.guards$X2PPG)
```

$QQ$-plot i histogram za postotak pogođenih 3 point šuta za 'Center' i 'Shooting Guard':
```{r}
# Plot histogram and QQ-plot in order to check for data normality. If data is not
# normally distributed we cannot use parametric tests such as t-test.
hist(centers$X3PPG)
boxplot(centers$X3PPG, main="Centers - trice")
qqPlot(centers$X3PPG)
hist(s.guards$X3PPG)
boxplot(s.guards$X3PPG, main="Shooting guards - trice")
qqPlot(s.guards$X3PPG)
```

Iz prikazanih grafova možemo zaključiti da parametarski $t$-test možemo koristiti samo za postotak realizacije 2 point šuta. Stoga, pogledajmo najprije uz pomoć $f$-testa možemo li pretpostaviti jednakost varijanci za postotke realizacije 2 point šuta pozicija 'Center' i 'Shooting Guard'. Na koncu, provedimo sam $t$-test.
```{r}
# First we test for the equality of variances, then we perform a t-test.
var2ppg.equal = var.test(centers$X2PPG, s.guards$X2PPG, alternative = "two.sided")$p.value > f.alpha
t.test(x = centers$X2PPG, y = s.guards$X2PPG, alternative = "greater", mu = 0,
       var.equal = var2ppg.equal, conf.level = 1-t.alpha)
```
Zaključujemo kako na razini značajnosti od 5% možemo tvrditi da je postotak realizacije 2 point šuta veći kod pozicije 'Center' u odnosu na poziciju 'Shooting Guard'.

U prethodnom koraku rekli smo kako ne možemo koristiti parametarski $t$-test za postotak realizacije 3 point šuta jer ne vrijedi pretpostavka normalnosti podataka. No, možemo si pomoći koristeći neparametarski test Bootstrap.
```{r}
# Define total number of iterations for function 'bs.interval'.
replica.count = 1E5

# Since we have two populations the idea is to bootstrap first and second population
# and then because we are perfroming a test whether percentage of 3 point shots of guards
# is greater than for centers we will be substracting one from each other.
# Finally, we calculate confidence interval and the lower bound in order to decide whether
# we reject null hypotesis that percentages are equal or not.
interval = bs.interval(x = s.guards$X3PPG,
                       y = centers$X3PPG,
                       B = replica.count,
                       alpha = t.alpha,
                       alternative = "greater")
lower.bound = round(interval[1], digits = 5)
upper.bound = interval[2]

message("Interval povjerenja jednak je: [", lower.bound, ", ", upper.bound, "].\n")
```
Nakon provedenog testa vidimo da 0 'nije upala' u interval povjerenja pa možemo uz razinu značajnosti od 5% tvrditi kako pozicija 'Shooting guard' zaista ima veći postotak realizacije 3 point šuta u odnosu na poziciju 'Center'.



# TODO
# 4. Da li su igrači bolji u prvoj polovici karijere ili u drugoj?
Igrači su najbolji u sredini svoje karijere jer na početku nisu previše iskusni a na kraju su većinom prestari i fizički iscrpljeni zbog čega igraju lošije.
```{r}
read.csv("nba-players-stats/Kobe_Bryant.csv") -> kobe
plot(kobe$Season, kobe$PTS)
hist(kobe$PTS)
```



# TODO
# 5. Da li širina raspona ruku utječe na efikasnost ukradenih lopti?
```{r}
```



# 6. Imaju li igrači iz Košarkaške Kuće slavnih više pogođenih trica u odnosu na ostale?
Jedno od zanimljivh pitanja koje se postavlja jest jesu li igrači koji su dospjeli u Košarkašku Kuću slavnih bolji u smislu realizacije trica u odnosu na igrače koji nisu u Košarkaškoj Kući slavnih. Na prvi pogled, osoba koja nije previše upućena u svijet košarke bi mogla tvrditi kako su slavni igrači zasigurno bolji. Ovim testom pokušati ćemo pokazati baš suprotno. Razdvojit ćemo igrače koji su u Košarkaškoj Kući od onih koji nisu. Najprije ćemo provesti $f$-test kako bi znali možemo li pretpostaviti jednakost varijanci, zatim crtamo $QQ$-plot kojim provjeravamo jesu li zadovoljene pretpostavke o normalnosti populacija te konačno provodimo $t$-test.
```{r}
# Before we start with anything we should define levels of confidence.
f.alpha = 0.05
t.alpha = 0.05

# Load players and their 3P%. Important note: players have to more than one attempt
# to shoot a 3 point. This way we remove a lot of outliers that would have 100%.
# Aslo, only players that have scored at least one three point are taken into account.
players.bySeasons %>% select(Player, X3P, X3PA) %>%
                  na.omit %>%
                  group_by(Player) %>% 
                  summarise(three.p = sum(X3P)/sum(X3PA), all.attempts = sum(X3PA)) %>%
                  filter(all.attempts > 1 & three.p > 0) -> all.players

# Divide players into 2 groups: Hall of Fame players and ones that are not.
HOF.players = all.players[grep("\\*", all.players$Player),]
NOR.players = setdiff(all.players, HOF.players)

# Before performing a t-test we should first check for the equality of the variances.
# In case there is sufficient evidence to support the claim that variances are equal,
# then we can more easily reject the null hypothesis that there is no difference in
# three point percentage between Hall of Fame players and ones that are not in Hall.
var.eq.p.value = var.test(NOR.players$three.p, HOF.players$three.p, alternative = "two.sided")$p.value
```

Boxplot te $QQ$-plot za igrače koji nisu dospjeli u Košarkašku Kuću slavnih i one koji jesu:
```{r}
# Next step is to check for normality of the data. Otherwise we cannot perform t-test.
boxplot(NOR.players$three.p, main="Postotak realizacije trica - ostali igrači")
boxplot(HOF.players$three.p, main="Postotak realizacije trica - Hall of Fame igrači")
qqPlot(NOR.players$three.p)
qqPlot(HOF.players$three.p)
```

Rezultati $t$-testa:
```{r}
# Finally we perform a t-test. Bear in mind that we are actually trying to test
# something that might be counterintuitive at first. Here we are trying to prove
# that players that are in Hall of Fame have LOWER percentage of 3 point scores
# compared to the ones that are not in Hall of Fame.
t.test(x = NOR.players$three.p, y = HOF.players$three.p, alternative = "greater", mu = 0,
       var.equal = var.eq.p.value > f.alpha, conf.level = 1-t.alpha)
```
Nakon provedenog $t$-testa možemo zaključiti na razini značajnosti od 5% kako igrači koji su dospjeli u Košarkašku Kuću slavnih imaju manji postotak pogođenih 3 point šuta u odonsu na igrače koji nisu u Košarkaškoj Kući slavnih. 



# TODO:
# 7. Da li su bolji igrači podrijetlom iz USA ili ostatka svijeta?
```{r}
```



8. Uniformna raspodjela pozicija igrača Košarkaške Kuće slavnih
Jesu li se pozicije igrača koji su dospjeli u Košarkašku Kuću slavnih ravnomjerno raspodijeljene? Točnije, zanima nas jesu li određene pozicije popularnije u smislu da igrači koji igraju na tim pozicijama ostvaruju takve rezultate i uspjehe da to u konačnici rezultirati ulaskom u Košarkašku Kuću slavnih. Koristit ćemo $\chi^2$-test odnosno test prilagodbe modela podatcima.
```{r}
# Utility function used for extracting number of players for certain position.
pos.len = function(pos, players) {
  players[grep(pos, players$Pos),] %>% distinct(Player) -> pos.players
  return(length(pos.players$Player))
}

# Extract Hall of Fame players.
players.bySeasons %>% select(Player, Pos) %>% 
                  na.omit %>%
                  filter(grepl("\\*", Player)) -> HOF.players

# Create a vector which actually represents a distribution of positions of Hall of Fame players.
dist.of.pos = c(pos.len("PG", HOF.players),
                pos.len("SG", HOF.players),
                pos.len("SF", HOF.players),
                pos.len("PF", HOF.players),
                pos.len("C",  HOF.players))
num.of.pos = length(dist.of.pos)

# Prepare a uniform distribution and contingency table in order to perform a chi-squred test.
uniform = rep(1, num.of.pos) * (sum(dist.of.pos) / num.of.pos)
table = rbind(dist.of.pos, uniform)
```

Rezultati $\chi^2$-testa te raspodjela Hall of Fame igrača po pozicijama:
```{r}
chisq.test(table)
barplot(dist.of.pos, names.arg = c("PG", "SG", "SF", "PF", "C"))
```
